#! /bin/sh

die() {
    echo
    echo "$@"
    exit 1
}

BASEDIR="$(dirname "$(readlink -f "$0")")"

[ -d /cache/arch-pkgs ] || sudo mkdir /cache/arch-pkgs
[ -d /cache/flathub-pkgs ] || sudo mkdir /cache/flathub-pkgs
[ -d /cache/aur ] || sudo mkdir /cache/aur
[ -d /cache/aur/metadata ] || sudo mkdir /cache/aur/metadata
[ -d /cache/aur/repos ] || sudo mkdir /cache/aur/repos

sudo chown -R 998:998 /cache/aur/metadata || die "Could not set aur/metadata permissions"
sudo chown -R 998:998 /cache/aur/repos || die "Could not set aur/repos permissions"

git pull


reflector --protocol https --country GB --fastest 20 --sort age --save "$BASEDIR/mirrorlist"

#sudo chown -R 10001:65533 /cache/arch-pkgs || die "Could not set npm permissions"

sudo docker volume create \
  --opt type=none \
  --opt o=bind \
  --opt device=/cache/aur/metadata \
  cache-aur-metadata

sudo docker volume create \
  --opt type=none \
  --opt o=bind \
  --opt device=/cache/aur/repos \
  cache-aur-repos

sudo docker volume create \
  --opt type=none \
  --opt o=bind \
  --opt device=/cache/flathub-pkgs \
  cache-flathub

sudo docker volume create \
  --opt type=none \
  --opt o=bind \
  --opt device=/cache/arch-pkgs \
  cache-pacoloco

sudo docker compose pull || die "Could not pull images"
sudo docker compose build || die "Could not build images"

sudo docker compose up -d --remove-orphans || die "Could not start containers"
